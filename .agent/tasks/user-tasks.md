# Mirror Chat - ユーザータスク一覧

> **このドキュメントについて**
> ユーザーが実装してほしいタスク、バグ修正、改善要望を書き貯めるドキュメントです。
> 適切なLLMモデルが選択されている際に、確認をした上で積極的にタスクを実装していきます。

## ⚠️ AGENT OPERATIONAL RULES (エージェント運用ルール)

以下のルールは、本プロジェクトを担当するエージェントに対する永続的な指示です。

1. **サーバー自動再起動**:
   - タスク実行中にローカルサーバー（Web: `http://localhost:3000`, Supabase: `54321`ポート等）への接続エラーを検知した場合、ユーザーの許可を待たずに以下のコマンドを実行して再起動を試みてください。
     - Webサーバー: `cd apps/web && npm run dev`
     - Supabase: `npx supabase start`
   - エラー検知は `read_url_content` や `browser_subagent` の失敗、あるいはAPIコールのタイムアウト等をトリガーとします。

2. **ドキュメント管理**:
   - この `user-tasks.md` は常に最新の状態に保ってください。
   - 新規タスクは必ずID (`CAT-XXX`) を付与してリストに追加してください。
   - 完了したタスクは `## ✅ Completed Tasks` セクションに移動し、完了日を記録してください。

---

## 📋 タスク管理ルール

### ステータス定義
| ステータス | 説明 |
|-----------|------|
| `To do` | 未着手 |
| `In Progress` | 作業中 |
| `Review` | 確認待ち |
| `Done` | 完了 |
| `On Hold` | 保留（検討中・要相談） |

### 優先度定義
| 優先度 | 説明 |
|--------|------|
| 🔴 High | 緊急・重要 |
| 🟡 Medium | 通常 |
| 🟢 Low | 余裕があれば |

---

## 🏃 Active Tasks (To Do / In Progress)

### 🔴 High Priority

#### 分割/窓からのAPI追加が失敗する
- **ID**: CAT-006
- **ステータス**: `To do`
- **カテゴリ**: BUG
- **説明**: AIスレッドの案内（分割/窓）からAPI追加すると `crypto.subtle.generateKey` が undefined になる

### 🟡 Medium Priority

#### 指定セリフでのみLLMが応答する設定
- **ID**: FEAT-002
- **ステータス**: `To do`
- **カテゴリ**: AI
- **説明**: AIスレッドで指定したセリフを言ったときのみLLMがレスポンスするように設定可能に

#### AIスレッド新規作成を共有時に選択可能
- **ID**: FEAT-004
- **ステータス**: `To do`
- **カテゴリ**: DB
- **説明**: 友達へのチャットでの共有時に、新規作成も選択できるようにする

#### Gemini 3 Pro等のモデル選択追加
- **ID**: FEAT-005
- **ステータス**: `To do`
- **カテゴリ**: AI
- **説明**: Gemini3proなどをモデル選択できるようにする

#### AIスレッド複製のリアルタイム反映
- **ID**: CAT-013
- **ステータス**: `To do`
- **カテゴリ**: UI
- **説明**: 「複製して新規作成」したAIスレッドが一覧に即時反映されるようにする（リロード不要）

#### AIに読ませるログの送信先と文面修正
- **ID**: CAT-014
- **ステータス**: `To do`
- **カテゴリ**: LOG
- **説明**: AIに読ませる ON/OFF のログをスレッドではなくトークに出し、「[ユーザ]がAIに読ませるをオン・オフにしました」と記録する

#### チャットコンテキスト自動ログの整理
- **ID**: CAT-015
- **ステータス**: `To do`
- **カテゴリ**: LOG
- **説明**: スレッドの `[CHAT_CONTEXT] ユーザ: ...` ログを廃止し、`[CHAT_CONTEXT_STATUS]` 系は「誰が何をどうしたか」を日本語で記録する

#### AIスレッド上部バーの作成者アイコン表示
- **ID**: CAT-016
- **ステータス**: `To do`
- **カテゴリ**: UI
- **説明**: スレッド上部バーの日付右横に作成者アイコンを圧縮なしで表示する

#### モバイル分割時のフォーカス最適化復旧
- **ID**: CAT-017
- **ステータス**: `To do`
- **カテゴリ**: UI
- **説明**: トーク/スレッドの分割表示で入力中にUIが最適化される挙動を再度有効にする

#### グループ既読表示の改善
- **ID**: CAT-018
- **ステータス**: `To do`
- **カテゴリ**: UI
- **説明**: グループチャットの既読を「既読 2」など人数表示にし、タップで既読ユーザのアイコンと名前一覧を表示する

#### モバイルでスレッド全画面時のタブ非表示
- **ID**: CAT-019
- **ステータス**: `To do`
- **カテゴリ**: UI
- **説明**: モバイルでスレッドをフル表示中は下部タブ（プロフ/トーク等）を非表示にする


#### スレッドタブのレイアウト最適化
- **ID**: CAT-021
- **ステータス**: `To do`
- **カテゴリ**: UI
- **説明**: スレッドタブでタイトルとその他情報を横並び・右詰めにし、タイトル/鉛筆は他情報が最大圧縮されるまで圧縮しない

#### 分割スレッド切替時の表示乱れ修正
- **ID**: CAT-025
- **ステータス**: `To do`
- **カテゴリ**: UI
- **説明**: 分割ビューで複数スレッドを切り替える際に表示が乱れる問題を解消する

#### 三点リーダーメニューの表示安定化
- **ID**: CAT-026
- **ステータス**: `To do`
- **カテゴリ**: UI
- **説明**: 全メニュー（三点リーダー）でガタつきや位置ズレなく安定表示させる

#### スレッド読取管理のラベル変更
- **ID**: CAT-027
- **ステータス**: `Done`
- **カテゴリ**: UI
- **説明**: スレッド読取管理の「このトークを読込先」表示を「モデル・共有日時・オーナー」表記に変更する（CAT-022/023と整合）

#### 読取ログ文面の統一（オン/オフ）
- **ID**: CAT-028
- **ステータス**: `Done`
- **カテゴリ**: LOG
- **説明**: 読取設定変更ログを「誰がどのスレッドの読込をオン/オフにしたか」を簡潔に記録し、オフ時もログを出す（CAT-014/015と整合）

#### トーク三点メニューの整理（グループ/個人）
- **ID**: CAT-029
- **ステータス**: `To do`
- **カテゴリ**: UI
- **説明**: トーク（グループ/個人）の三点リーダーメニューを整理・再配置し、重複や不要項目をなくして使いやすくする

#### システムプロンプトで複数ユーザーを明示
- **ID**: AI-001
- **ステータス**: `To do`
- **カテゴリ**: AI
- **説明**: AIスレッドのAIに、共有チャットで複数ユーザーがいることを認識させる

#### デッドコード/非効率コードの最適化
- **ID**: CODE-001
- **ステータス**: `To do`
- **カテゴリ**: その他
- **説明**: 非効率なコードを整理する

#### スレッド一覧の「共有」ラベルの改行崩れ
- **ID**: CAT-008
- **ステータス**: `To do`
- **カテゴリ**: UI
- **説明**: スレッド名が長いと「共有」が縦書きになる問題を解消する

#### 窓のリサイズを四辺対応に
- **ID**: CAT-009
- **ステータス**: `To do`
- **カテゴリ**: UI
- **説明**: 窓のサイズ調節を四辺からできるようにする

#### ブラウザ標準ポップアップの排除
- **ID**: CAT-010
- **ステータス**: `To do`
- **カテゴリ**: UI
- **説明**: 名前編集/メンバー削除/APIキー削除などのconfirm/promptをアプリ内UIに置き換える

#### 通知バッジ位置と三点リーダ調整（トーク/AI）
- **ID**: CAT-011
- **ステータス**: `To do`
- **カテゴリ**: UI
- **説明**: 通知バッジを三点リーダ左に移動し、三点リーダを縦向きにする（AIスレッド一覧も同様）

#### 三点リーダメニューの最前面表示
- **ID**: CAT-012
- **ステータス**: `To do`
- **カテゴリ**: UI
- **説明**: メニューが他要素の背面に潜らないよう最前面にする

### 🟢 Low Priority

#### 履歴の全コピー機能
- **ID**: FEAT-003
- **ステータス**: `To do`
- **カテゴリ**: UI
- **説明**: 履歴をテキストとして全部コピー可能に

### On Hold

#### iOS向けリリース検討
- **ID**: PLAN-001

#### OpenRouter API統合の検討
- **ID**: PLAN-002
 
 ### その他
 
 - **ワークフロー**: mainへの直接push前にブランチ切り＆レビュー推奨。大規模変更時はステージング確認のうえ反映。

---

## ✅ Completed Tasks

### Features & Fixes

#### モバイルの通知バッジが勝手に消える
- **ID**: CAT-007
- **ステータス**: `Done`
- **完了日**: 2026-01-11
- **説明**: モバイルでトークの通知バッジが未読のまま消える問題を解消

#### スレッド読取管理のラベル変更
- **ID**: CAT-027
- **ステータス**: `Done`
- **完了日**: 2026-01-11
- **説明**: スレッド読取管理UIの表記をモデル・共有日時・オーナーに変更し、トーク/スレッド側の表示を整合させた

#### 読取ログ文面の統一（オン/オフ）
- **ID**: CAT-028
- **ステータス**: `Done`
- **完了日**: 2026-01-11
- **説明**: 読取設定変更ログを「誰がどのスレッドの読取をオン/オフにしたか」に統一し、オフ時もログが出るようにした

#### グループ機能の全面的な整備
- **ID**: FEAT-006
- **ステータス**: `Done`
- **完了日**: 2026-01-11
- **説明**: グループ作成時・作成後のユーザー招待、アイコン設定、その他グループ機能の整備

#### ファイル選択ボタンの修正
- **ID**: BUG-005
- **ステータス**: `Done`
- **完了日**: 2026-01-11
- **説明**: チャット画面のファイル選択ボタンを押しても何も動作しない問題を修正（input要素のスタイル調整とイベント伝播制御）

#### Supabase API Key の暗号化
- **ID**: SEC-001
- **ステータス**: `Done`
- **完了日**: 2026-01-11

#### モバイル - AIスレッド本スレッドでスクロール/入力不可
- **ID**: BUG-001
- **ステータス**: `Done`
- **完了日**: 2026-01-10

#### グループ作成不可
- **ID**: BUG-002
- **ステータス**: `Done`
- **完了日**: 2026-01-10

#### AIスレッド三点リーダーの重複メニュー
- **ID**: BUG-003
- **ステータス**: `Done`
- **完了日**: 2026-01-10

#### モバイル - AIスレッド一覧の新規作成ボタンをフローティングに
- **ID**: UI-001
- **ステータス**: `Done`
- **完了日**: 2026-01-11

#### モバイル分割 - 最新へ自動スクロール
- **ID**: UI-002
- **ステータス**: `Done`

#### トーク一覧検索 - 不要表示の削除
- **ID**: UI-003
- **ステータス**: `Done`

#### モバイル分割 - キーボード表示時の最適表示
- **ID**: UI-004
- **ステータス**: `Done`

#### 動画送信の禁止
- **ID**: UI-006
- **ステータス**: `Done`

#### モバイル分割 - AIスレッド内から移動可能に
- **ID**: UI-007
- **ステータス**: `Done`

#### モバイル分割 - 三点リーダーメニューの表示位置調整
- **ID**: UI-008
- **ステータス**: `Done`

#### 友達一覧 - 自分プロフィールのレイアウト変更
- **ID**: UI-009
- **ステータス**: `Done`

#### チャットでリンクを有効化
- **ID**: UI-010
- **ステータス**: `Done`

#### メッセージカード/画像の土台削除
- **ID**: UI-011
- **ステータス**: `Done`

#### 画像ドラッグ送信
- **ID**: UI-012
- **ステータス**: `Done`

#### AIスレッド一覧に三点リーダー追加
- **ID**: UI-005
- **ステータス**: `Done`
- **完了日**: 2026-01-11
- **説明**: AIスレッド一覧画面の各スレッドに三点リーダーを実装し、一覧から編集可能に

#### AIスレッドUIをGPTグループチャット風に
- **ID**: UI-013
- **ステータス**: `Done`
- **完了日**: 2026-01-11
- **説明**: UIをGPTのグループチャットっぽくする　具体的には、LLMのメッセージについてはバブルをつけないようにする

#### AIスレッドのマークダウン表示対応
- **ID**: UI-014
- **ステータス**: `Done`
- **完了日**: 2026-01-11
- **説明**: AIスレッドのメッセージのマークダウン（コードブロック、太字等）をリッチテキスト表示にする

#### トーク一覧検索 - 投稿日時表示
- **ID**: SEARCH-001
- **ステータス**: `Done`
- **完了日**: 2026-01-11
- **説明**: トーク一覧から検索した際に投稿日時を表示

#### バージョン表示位置の変更と統合
- **ID**: UI-015
- **ステータス**: `Done`
- **完了日**: 2026-01-11
- **説明**: 画面上のGitコミットハッシュ表示を削除し、バージョン番号表示箇所に統合・置換。日時を表示し、モバイルでは設定画面の下部に配置しました。

#### 共有チャット - 『AIに読ませる』トグル
- **ID**: FEAT-001
- **ステータス**: `Done`
- **完了日**: 2026-01-11
- **説明**: 共有チャットの三点リーダーに「AIに読ませる」トグルを追加し、共有スレッドへチャット文脈を反映できるようにしました。

#### 検索ヒットワードのハイライト
- **ID**: SEARCH-002
- **ステータス**: `Done`
- **完了日**: 2026-01-11
- **説明**: 検索時にヒットワードをハイライト表示

#### チャットメニューからグループ設定・招待への直接遷移
- **ID**: UI-017
- **ステータス**: `Done`
- **完了日**: 2026-01-11
- **説明**: チャット画面右上のメニューから、グループ設定の「メンバー」「招待」「設定」タブへ直接遷移できるように改善する

#### グループ招待時の友達一覧が表示されない
- **ID**: BUG-006
- **ステータス**: `Done`
- **完了日**: 2026-01-11
- **説明**: 招待画面で友達一覧が空になるバグを、`friendships`テーブルを requester/addressee に分けて fetched し、accepted ステータスとプロフィールで絞る実装に見直すことで修正しました。

#### グループ設定が保存できない
- **ID**: BUG-007
- **ステータス**: `Done`
- **完了日**: 2026-01-11
- **説明**: オーナーだけが変更できるようチェックを入れつつ、グループ名・アイコンの保存で新しいパス＋更新日時を supabase に渡し、RLS による更新エラーを防止しました。

#### トーク検索結果選択時の自動スクロール
- **ID**: BUG-008
- **ステータス**: `Done`
- **完了日**: 2026-01-11
- **説明**: トーク検索結果を選んだ際に該当メッセージへ自動スクロールし、対象メッセージを強調表示するように修正しました。

#### AIスレッド一覧の重複表示/共有マークの統一
- **ID**: CAT-001
- **ステータス**: `Done`
- **完了日**: 2026-01-11
- **説明**: 自分のスレッドが共有された際に二重表示される問題を解消し、共有マークが正しく表示されるように修正しました。

#### 分割タブ名の同期と最小化表示
- **ID**: CAT-002
- **ステータス**: `Done`
- **完了日**: 2026-01-11
- **説明**: 分割タブの表示名をスレッドの実タイトルに同期し、最小化時の表示をスレッドタイトルに統一しました。

#### モバイル分割の入力フォーカス時表示（AI/対人）
- **ID**: CAT-003
- **ステータス**: `Done`
- **完了日**: 2026-01-11
- **説明**: モバイル分割で入力時に該当ログのみが表示されるよう、AIスレッド/対人チャット双方で挙動を統一しました。

#### モバイル分割の送信ボタン位置調整
- **ID**: CAT-004
- **ステータス**: `Done`
- **完了日**: 2026-01-11
- **説明**: モバイル分割時の送信ボタンの縦位置を入力欄と揃えました。

#### 三点リーダーメニューのガクつき防止（一覧系）
- **ID**: CAT-005
- **ステータス**: `Done`
- **完了日**: 2026-01-11
- **説明**: トーク一覧/AIスレッド一覧/チャット右上メニューで、初回表示時の位置ズレが見えないように修正しました。

#### 個人トークでもスレッド読取管理を共通化
- **ID**: CAT-030
- **ステータス**: `Done`
- **完了日**: 2026-01-11
- **説明**: DMでもグループと同じ「スレッド読取管理」メニューを利用できるようにし、読込先が他トークになった場合はリストに表示しないよう整理


スレッドの複製して新規作成時にAIスレッド一覧にリロードしないと追加されないので、リアルタイムで更新されるようにして
AIに読ませる　のON OFFのログは、スレッドではなくトークとに送るようにして　あとその本文は、[ユーザ]がAIに読ませるをオン・オフにしました　というような感じにして
スレッドにおける[CHAT_CONTEXT] 預忠道: にゃっす　みたいなログは廃止して
[CHAT_CONTEXT_STATUS] ON　とかのログについて、何を誰がどうしたか、日本語で書くようにして
スレッドの上部バーにおいて、日付の右横に作成者のアイコンが圧縮されない形で表示されるようにして
モバイルでのフォーカスの実装が戻っちゃってるので、トーク、スレッドそれぞれ、分割の際の入力中にUIが最適化されるようにして
グループチャットの既読を、従来の既読の文字があった場所に、既読 2　みたいな表示にして、、タップすると既読したユーザたちのアイコンとユーザ名が一覧できるようにして
モバイルでスレッドをフルで開いている際は、プロフ、トーク等の下部のタブは表示されないようにして
AIスレッドの背景を、いい感じのグラデーションにして
スレッドの上部について、タイトル、鉛筆アイコンとその他情報を横並びにして、その他情報は右詰めにして　タイトルと鉛筆は他が最大まで圧縮されるまでは圧縮しないで
スレッド名の編集時にはトップバーに乗ってるのは入力欄のみにして
