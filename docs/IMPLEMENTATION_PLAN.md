# Mirror Chat - å®Ÿè£…è¨ˆç”»æ›¸

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦
**Mirror Chat**ã¯ã€ŒLINE/Discordå‹ã®é€šå¸¸ãƒãƒ£ãƒƒãƒˆã€ï¼‹ã€ŒChatGPTé¢¨ã®AIã‚¹ãƒ¬ãƒƒãƒ‰ã€ã‚’åŒä¸€UIã§æä¾›ã—ã€AIã‚¹ãƒ¬ãƒƒãƒ‰ã‚’"å…±æœ‰ã‚«ãƒ¼ãƒ‰"ã¨ã—ã¦ãƒˆãƒ¼ã‚¯ã«é€ä¿¡â†’å—ã‘æ‰‹ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é–²è¦§ãƒ»ä»‹å…¥ã§ãã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€‚

---

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

| ã‚«ãƒ†ã‚´ãƒª | æŠ€è¡“ | ç†ç”± |
|---------|------|------|
| Frontend | Next.js 14 (App Router) + TypeScript | ãƒ¢ãƒ€ãƒ³ãªReactãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ |
| Styling | Tailwind CSS v3 | ä»•æ§˜æ›¸ã§æŒ‡å®š |
| Stateç®¡ç† | Zustand | è»½é‡ã§ä½¿ã„ã‚„ã™ã„ |
| Backend | Supabase | Auth/DB/Realtime/Storage/Edge Functionsçµ±åˆ |
| AIå®Ÿè¡Œ | Supabase Edge Functions (Deno) | OpenAI APIå‘¼ã³å‡ºã— |
| Hosting | Vercel Free | WebSocketä¸è¦ï¼ˆSupabase Realtimeã§ä»£æ›¿ï¼‰ |

---

## ãƒ•ã‚§ãƒ¼ã‚ºåˆ¥å®Ÿè£…è¨ˆç”»

### Phase 1: åŸºç›¤æ§‹ç¯‰ï¼ˆ1-2æ—¥ï¼‰ âœ… **å®Œäº†**
- [x] Next.js + Tailwind ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–
- [x] ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ä½œæˆ
- [x] Supabase ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³SQLä½œæˆï¼ˆ4ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
- [x] åŸºæœ¬UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã€ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰
- [x] Supabase ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®šï¼ˆãƒ–ãƒ©ã‚¦ã‚¶/ã‚µãƒ¼ãƒãƒ¼/ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ï¼‰
- [x] èªè¨¼ãƒ•ãƒ­ãƒ¼ï¼ˆãƒ­ã‚°ã‚¤ãƒ³/æ–°è¦ç™»éŒ²ãƒšãƒ¼ã‚¸ï¼‰
- [x] ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆDesktopå·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ / Mobileãƒœãƒˆãƒ ãƒŠãƒ“ï¼‰
- [x] å‹å®šç¾©ï¼ˆDatabase typesï¼‰
- [x] Zustandã‚¹ãƒˆã‚¢ï¼ˆAuth, UI, Overlay, Split, Chat, AIï¼‰
- [x] Edge Functionsé››å½¢ï¼ˆkey_set, key_delete, ai_send_messageï¼‰

**æ³¨æ„**: Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆã¨ç’°å¢ƒå¤‰æ•°ã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚

### Phase 2: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ»å‹é”ãƒ»ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆ2-3æ—¥ï¼‰ âœ… **å®Œäº†**
- [x] ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤º/ç·¨é›† (`ProfileView.tsx`)
- [x] ã‚¢ãƒã‚¿ãƒ¼ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (UIå®Ÿè£…æ¸ˆã¿ã€Backendæœªç¢ºèª)
- [x] å‹é”æ¤œç´¢ãƒ»è¿½åŠ ãƒ»æ‰¿èª (`FriendsList.tsx`)
- [x] ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆãƒ»æ‹›å¾…ãƒ»ç®¡ç† (`GroupsList.tsx`)

### Phase 3: ãƒˆãƒ¼ã‚¯æ©Ÿèƒ½ï¼ˆ3-4æ—¥ï¼‰ âœ… **å®Œäº†**
- [x] ãƒ«ãƒ¼ãƒ ä¸€è¦§è¡¨ç¤º (`RoomList.tsx`)
- [x] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€å—ä¿¡ (`ChatRoom.tsx`)
- [x] æ—¢èª­æ©Ÿèƒ½ (è‡ªå‹•æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…æ¸ˆã¿)
- [x] å…¥åŠ›ä¸­ï¼ˆtypingï¼‰è¡¨ç¤º
- [x] ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
- [x] ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜
- [x] å¼•ç”¨è¿”ä¿¡

### Phase 4: AIã‚¹ãƒ¬ãƒƒãƒ‰åŸºæœ¬æ©Ÿèƒ½ï¼ˆ2-3æ—¥ï¼‰ âœ… **å®Œäº†**
- [x] ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§/ä½œæˆ/è¡¨ç¤º (`ThreadList.tsx`, `AIThreadView.tsx`)
- [x] Edge Function: `ai_send_message` (å®Ÿè£…å®Œäº†)
- [x] AIã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å—ä¿¡ãƒ­ã‚¸ãƒƒã‚¯ (Client & Edge)
- [x] ãƒªãƒãƒ¼ãƒ /å‰Šé™¤/ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
- [x] ã‚¹ãƒ¬ãƒƒãƒ‰è¤‡è£½ï¼ˆDuplicateï¼‰
- [x] APIã‚­ãƒ¼ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«
- [x] Edge Function: `key_set`, `key_delete`

### Phase 5: AIã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ï¼ˆ2æ—¥ï¼‰ âœ… **å®Œäº†**
- [x] ai_stream_eventsè³¼èª­ (å®Ÿè£…æ¸ˆã¿)
- [x] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°è¡¨ç¤º (å®Ÿè£…æ¸ˆã¿)
- [x] Edge Function: ai_process_queue

### Phase 6: å…±æœ‰ã‚«ãƒ¼ãƒ‰ãƒ»ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆ3-4æ—¥ï¼‰ âœ… **å®Œäº†**
- [x] å…±æœ‰ã‚«ãƒ¼ãƒ‰é€ä¿¡
- [x] ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤ºï¼ˆãƒ‰ãƒ©ãƒƒã‚°/ãƒªã‚µã‚¤ã‚º/Zé †/æœ€å°åŒ–ï¼‰
- [x] Desktopã‚¹ãƒ—ãƒªãƒƒãƒˆï¼ˆå³ãƒšã‚¤ãƒ³+ã‚¿ãƒ–ï¼‰
- [x] Mobileã‚¹ãƒ—ãƒªãƒƒãƒˆï¼ˆä¸Šä¸‹åˆ†å‰²ï¼‰
- [x] localStorageçŠ¶æ…‹ä¿å­˜/å¾©å…ƒ

### Phase 7: ä»‹å…¥æ©Ÿèƒ½ï¼ˆ2æ—¥ï¼‰ âœ… **å®Œäº†**
- [x] VIEW/INTERVENEæ¨©é™ç®¡ç†
- [x] ä»‹å…¥ã‚­ãƒ¥ãƒ¼ï¼ˆai_queue_itemsï¼‰
- [x] æ¨©é™å‰¥å¥ªæ™‚ã®ã‚­ãƒ¥ãƒ¼ç ´æ£„
- [x] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¨©é™å¤‰æ›´åæ˜ 

### Phase 8: è¨­å®šãƒ»ä»•ä¸Šã’ï¼ˆ1-2æ—¥ï¼‰ âœ… **å®Œäº†**
- [x] æ–‡å­—ã‚µã‚¤ã‚ºè¨­å®š
- [x] Mobileæœ€é©åŒ–
- [x] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
- [x] E2Eãƒ†ã‚¹ãƒˆ

---

## ç”³ã—é€ã‚Šäº‹é … (Current Status & Handover Notes)

### ç¾åœ¨ã®çŠ¶æ³
- **ãƒˆãƒ¼ã‚¯æ©Ÿèƒ½**: æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã€å¼•ç”¨è¿”ä¿¡ã€ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€å…±æœ‰ã‚«ãƒ¼ãƒ‰è¡¨ç¤º/é€ä¿¡ã¾ã§å®Ÿè£…æ¸ˆã¿ã€‚
- **AIæ©Ÿèƒ½**: ã‚¹ãƒ¬ãƒƒãƒ‰è¤‡è£½ã€APIã‚­ãƒ¼ç™»éŒ²ï¼ˆè¨­å®š/ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ã€å…±æœ‰ãƒ»æ¨©é™ç®¡ç†ã€ä»‹å…¥ã‚­ãƒ¥ãƒ¼ã€ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤/ã‚¹ãƒ—ãƒªãƒƒãƒˆé€£æºã¾ã§å®Ÿè£…æ¸ˆã¿ã€‚

### æŠ±ãˆã¦ã„ã‚‹å•é¡Œ (Known Issues)
1. **å‹å®‰å…¨æ€§ (Type Safety)**:
   - Supabaseã®å‹å®šç¾©ã¨å®Ÿéš›ã®ã‚¯ã‚¨ãƒªã§ä½¿ç”¨ã™ã‚‹å‹ã¨ã®ä¸æ•´åˆãŒå¤šãã€`as any` ã‚­ãƒ£ã‚¹ãƒˆã§å›é¿ã—ã¦ã„ã‚‹ç®‡æ‰€ãŒå¤šæ•°ã‚ã‚‹ï¼ˆ`ChatRoom.tsx`, `FriendsList.tsx` ç­‰ï¼‰ã€‚
   - å°†æ¥çš„ã«ã¯ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ã‚’æ­£ã—ãä½¿ç”¨ã™ã‚‹ã‹ã€å‹å®šç¾©ã‚’è¦‹ç›´ã™ã¹ãã€‚
2. **APIã‚­ãƒ¼ç®¡ç†**:
   - `ENCRYPTION_SECRET` ãŒæœªè¨­å®šã ã¨ `key_set`/`key_delete` ãŒå¤±æ•—ã™ã‚‹ã€‚
3. **Edge Functions**:
   - `ai_send_message`/`ai_process_queue`/`ai_duplicate_thread`/`key_set`/`key_delete` ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¿…è¦ã€‚

### æ¬¡ã«å–ã‚Šçµ„ã‚€ã¹ãã‚¿ã‚¹ã‚¯
1. **Supabase Edge Functions ãƒ‡ãƒ—ãƒ­ã‚¤**:
   - `supabase functions deploy ai_send_message`
   - `supabase functions deploy ai_process_queue`
   - `supabase functions deploy ai_duplicate_thread`
   - `supabase functions deploy key_set`
   - `supabase functions deploy key_delete`
2. **Supabase Secrets**:
   - `supabase secrets set ENCRYPTION_SECRET=...`
   - ï¼ˆä»»æ„ï¼‰`OPENAI_API_KEY` ã¯å…±é€šã‚­ãƒ¼ã‚’ä½¿ã†å ´åˆã®ã¿è¨­å®š
3. **E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ**:
   - `cd apps/web && npx playwright install`
   - `cd apps/web && npm run test:e2e`

---

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
mirror-chat-dev/
â”œâ”€â”€ apps/
â”‚   â””â”€â”€ web/                          # Next.js ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
â”‚       â”œâ”€â”€ app/
â”‚       â”‚   â”œâ”€â”€ (auth)/               # èªè¨¼é–¢é€£ãƒšãƒ¼ã‚¸
â”‚       â”‚   â”‚   â”œâ”€â”€ login/
â”‚       â”‚   â”‚   â””â”€â”€ register/
â”‚       â”‚   â”œâ”€â”€ (main)/               # ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª
â”‚       â”‚   â”‚   â”œâ”€â”€ profile/
â”‚       â”‚   â”‚   â”œâ”€â”€ talk/
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ [roomId]/
â”‚       â”‚   â”‚   â”œâ”€â”€ ai/
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ [threadId]/
â”‚       â”‚   â”‚   â””â”€â”€ settings/
â”‚       â”‚   â”œâ”€â”€ layout.tsx
â”‚       â”‚   â””â”€â”€ page.tsx
â”‚       â”œâ”€â”€ components/
â”‚       â”‚   â”œâ”€â”€ nav/                  # ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
â”‚       â”‚   â”œâ”€â”€ chat/                 # ãƒãƒ£ãƒƒãƒˆUI
â”‚       â”‚   â”œâ”€â”€ ai/                   # AIã‚¹ãƒ¬ãƒƒãƒ‰UI
â”‚       â”‚   â”œâ”€â”€ overlay/              # ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
â”‚       â”‚   â”œâ”€â”€ split/                # ã‚¹ãƒ—ãƒªãƒƒãƒˆè¡¨ç¤º
â”‚       â”‚   â””â”€â”€ ui/                   # å…±é€šUIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚       â”œâ”€â”€ lib/
â”‚       â”‚   â”œâ”€â”€ supabase/             # Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
â”‚       â”‚   â”œâ”€â”€ stores/               # Zustand stores
â”‚       â”‚   â””â”€â”€ utils/                # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚       â”œâ”€â”€ hooks/                    # ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
â”‚       â”œâ”€â”€ types/                    # å‹å®šç¾©
â”‚       â””â”€â”€ styles/                   # ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚¿ã‚¤ãƒ«
â”œâ”€â”€ supabase/
â”‚   â”œâ”€â”€ migrations/                   # DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â””â”€â”€ functions/                    # Edge Functions
â”‚       â”œâ”€â”€ ai_send_message/
â”‚       â”œâ”€â”€ ai_process_queue/
â”‚       â”œâ”€â”€ ai_duplicate_thread/
â”‚       â”œâ”€â”€ key_set/
â”‚       â””â”€â”€ key_delete/
â”œâ”€â”€ docs/                             # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
â””â”€â”€ README.md
```

---

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒæ¦‚è¦

### ã‚³ã‚¢ãƒ†ãƒ¼ãƒ–ãƒ«
| ãƒ†ãƒ¼ãƒ–ãƒ« | èª¬æ˜ |
|----------|------|
| profiles | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« |
| friendships | å‹é”é–¢ä¿‚ |
| groups | ã‚°ãƒ«ãƒ¼ãƒ— |
| group_members | ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ |
| rooms | ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ï¼ˆDM/ã‚°ãƒ«ãƒ¼ãƒ—çµ±ä¸€ï¼‰ |
| room_members | ãƒ«ãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ |
| messages | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ |
| message_reactions | ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ |
| message_attachments | æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ« |

### AIã‚¹ãƒ¬ãƒƒãƒ‰é–¢é€£
| ãƒ†ãƒ¼ãƒ–ãƒ« | èª¬æ˜ |
|----------|------|
| ai_threads | AIã‚¹ãƒ¬ãƒƒãƒ‰ |
| ai_thread_members | ã‚¹ãƒ¬ãƒƒãƒ‰å…±æœ‰ãƒ¡ãƒ³ãƒãƒ¼ |
| ai_messages | AIä¼šè©±å±¥æ­´ |
| ai_queue_items | ä»‹å…¥ã‚­ãƒ¥ãƒ¼ |
| ai_runs | å®Ÿè¡Œç®¡ç† |
| ai_stream_events | ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å·®åˆ† |

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
| ãƒ†ãƒ¼ãƒ–ãƒ« | èª¬æ˜ |
|----------|------|
| user_llm_keys | æš—å·åŒ–APIã‚­ãƒ¼ |

---

## RLSï¼ˆRow Level Securityï¼‰æ–¹é‡

å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã§RLSã‚’æœ‰åŠ¹åŒ–ã—ã€ä»¥ä¸‹ã®ãƒãƒªã‚·ãƒ¼ã‚’é©ç”¨ï¼š

1. **profiles**: æœ¬äººã®ã¿æ›´æ–°ã€å…¨å“¡å‚ç…§å¯
2. **friendships**: å½“äº‹è€…ã®ã¿å‚ç…§/æ›´æ–°
3. **rooms/messages**: room_membersã®ã¿å‚ç…§
4. **ai_threads**: owner + ai_thread_members ã®ã¿å‚ç…§
5. **ai_thread_members**: ownerã®ã¿å¤‰æ›´å¯
6. **ai_queue_items**: INTERVENEæ¨©é™æŒã¡ã®ã¿ä½œæˆå¯

---

## ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¨­è¨ˆ

### Supabase Realtimeæ´»ç”¨
- **DB Changes**: messages, reactions, ai_messages, ai_stream_events
- **Broadcast**: typingï¼ˆæ®ç™ºçš„ï¼‰

### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè³¼èª­ãƒ‘ã‚¿ãƒ¼ãƒ³
```typescript
// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è³¼èª­
supabase.channel(`room:${roomId}`)
  .on('postgres_changes', { 
    event: 'INSERT', 
    schema: 'public', 
    table: 'messages',
    filter: `room_id=eq.${roomId}`
  }, handleNewMessage)
  .subscribe()

// AIã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°è³¼èª­
supabase.channel(`ai:${threadId}`)
  .on('postgres_changes', {
    event: 'INSERT',
    schema: 'public',
    table: 'ai_stream_events',
    filter: `thread_id=eq.${threadId}`
  }, handleStreamDelta)
  .subscribe()
```

---

## æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

1. âœ… å®Ÿè£…è¨ˆç”»æ›¸ä½œæˆ
2. ğŸ”„ Next.js ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–
3. ğŸ”„ Supabase ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³SQLä½œæˆ
4. ğŸ”„ åŸºæœ¬ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…
5. â³ Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå¿…è¦ï¼‰

---

*æœ€çµ‚æ›´æ–°: 2026-01-08*
